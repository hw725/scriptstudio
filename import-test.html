<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>ë°±ì—… ê°€ì ¸ì˜¤ê¸° í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        margin-top: 0;
      }
      button {
        background: #0066cc;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px 0;
      }
      button:hover {
        background: #0052a3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      #status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
        display: none;
      }
      #status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      #status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      #status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“¦ ë°±ì—… ê°€ì ¸ì˜¤ê¸°</h1>
      <p>export_new.json íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ê°€ì ¸ì˜¤ê¸°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</p>

      <input
        type="file"
        id="fileInput"
        accept=".json"
        style="display: none"
      />
      <button
        id="selectBtn"
        onclick="selectFile()"
      >
        íŒŒì¼ ì„ íƒ
      </button>
      <button
        id="importBtn"
        onclick="importData()"
        disabled
      >
        ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰
      </button>

      <div id="status"></div>
    </div>

    <script type="module">
      let selectedFile = null;
      let importBackupJSON = null;

      // Import í•¨ìˆ˜ ë¡œë“œ
      async function loadImportModule() {
        try {
          const mod = await import("/src/lib/import-backup.js");
          importBackupJSON = mod.importBackupJSON;
          showStatus("ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ", "success");
        } catch (err) {
          showStatus("ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨: " + err.message, "error");
        }
      }

      window.selectFile = function () {
        document.getElementById("fileInput").click();
      };

      document
        .getElementById("fileInput")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          selectedFile = file;
          document.getElementById("importBtn").disabled = false;
          showStatus(
            `ì„ íƒëœ íŒŒì¼: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`,
            "info"
          );
        });

      window.importData = async function () {
        if (!selectedFile) return;

        const btn = document.getElementById("importBtn");
        btn.disabled = true;
        btn.textContent = "ê°€ì ¸ì˜¤ëŠ” ì¤‘...";

        try {
          // ëª¨ë“ˆì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¡œë“œ
          if (!importBackupJSON) {
            await loadImportModule();
          }

          showStatus("íŒŒì¼ ì½ëŠ” ì¤‘...", "info");
          const text = await selectedFile.text();
          const json = JSON.parse(text);

          showStatus("ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "info");
          const report = await importBackupJSON(json, { mode: "upsert" });

          let message = "âœ… ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!\n\n";
          for (const [key, value] of Object.entries(report)) {
            if (value && typeof value === "object") {
              message += `${key}:\n`;
              message += `  ìƒì„±: ${value.created || 0}ê±´\n`;
              message += `  ì—…ë°ì´íŠ¸: ${value.updated || 0}ê±´\n`;
              if (value.errors > 0) {
                message += `  ì—ëŸ¬: ${value.errors}ê±´\n`;
              }
            }
          }

          showStatus(message, "success");

          setTimeout(() => {
            if (
              confirm(
                "ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
              )
            ) {
              window.location.href = "/";
            }
          }, 1000);
        } catch (err) {
          console.error("Import error:", err);
          showStatus(
            "âŒ ì˜¤ë¥˜ ë°œìƒ:\n" + err.message + "\n\nì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.",
            "error"
          );
        } finally {
          btn.disabled = false;
          btn.textContent = "ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰";
        }
      };

      function showStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = type;
        status.style.display = "block";
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“ˆ ë¡œë“œ
      loadImportModule();
    </script>
  </body>
</html>
